<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…çº§ç›ä¸½å¤šå…³å¡æ¸¸æˆ - å¸¦åˆ†æ•°è®°å½•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #5a94d4;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 1000px;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
            width: 100%;
        }
        
        .game-section {
            flex: 3;
        }
        
        .scores-section {
            flex: 1;
            min-width: 250px;
        }
        
        .game-header {
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            width: 100%;
        }
        
        .game-header h1 {
            font-size: 2.8rem;
            color: #f8d568;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        .game-header p {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        .stats-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            font-size: 1.2rem;
        }
        
        .game-canvas {
            border: 5px solid #8b4513;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            background-color: #87CEEB;
            width: 100%;
            max-width: 800px;
        }
        
        .controls {
            width: 100%;
            background-color: #333;
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        
        .controls h3 {
            color: #f8d568;
            margin-bottom: 10px;
        }
        
        .controls ul {
            list-style-type: none;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        
        .controls li {
            margin: 5px 10px;
            padding: 5px 10px;
            background-color: #555;
            border-radius: 5px;
        }
        
        .game-status {
            font-size: 1.5rem;
            color: white;
            text-align: center;
            padding: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .buttons {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            padding: 12px 25px;
            font-size: 1.2rem;
            background-color: #e52521;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 0 #8b0000;
        }
        
        button:hover {
            background-color: #ff3333;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #8b0000;
        }
        
        .scores-panel {
            background-color: #333;
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            height: 100%;
        }
        
        .scores-panel h3 {
            color: #f8d568;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.5rem;
        }
        
        .score-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .score-form input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            font-size: 1rem;
        }
        
        .score-form button {
            padding: 10px;
            font-size: 1rem;
        }
        
        .high-scores {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .score-item {
            background-color: #444;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .score-rank {
            font-weight: bold;
            color: #f8d568;
            font-size: 1.2rem;
            min-width: 30px;
        }
        
        .score-name {
            flex: 1;
            margin: 0 10px;
        }
        
        .score-value {
            font-weight: bold;
            color: #4CAF50;
            min-width: 80px;
            text-align: right;
        }
        
        .score-level {
            font-size: 0.9rem;
            color: #aaa;
            margin-left: 10px;
        }
        
        .level-info {
            color: #f8d568;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .instructions {
            width: 100%;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .instructions h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .instructions p {
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        @media (max-width: 1100px) {
            .main-content {
                flex-direction: column;
            }
            
            .scores-section {
                width: 100%;
            }
        }
        
        @media (max-width: 850px) {
            .game-canvas {
                height: auto;
            }
            
            .stats-container {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .controls ul {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>è¶…çº§ç›ä¸½å¤šå…³å¡æ¸¸æˆ</h1>
            <p>ä½¿ç”¨æ–¹å‘é”®ç§»åŠ¨ï¼Œç©ºæ ¼é”®è·³è·ƒï¼Œæ”¶é›†é‡‘å¸å¹¶åˆ°è¾¾æ——æ†ï¼</p>
        </div>
        
        <div class="main-content">
            <div class="game-section">
                <div class="stats-container">
                    <div>å¾—åˆ†: <span id="score">0</span></div>
                    <div>é‡‘å¸: <span id="coins">0</span></div>
                    <div>ç”Ÿå‘½: <span id="lives">3</span></div>
                    <div>å…³å¡: <span id="level">1</span></div>
                    <div class="level-info" id="levelName">è‰åœ°ä¸–ç•Œ</div>
                </div>
                
                <canvas id="gameCanvas" width="800" height="400" class="game-canvas"></canvas>
                
                <div class="game-status" id="gameStatus">ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"æŒ‰é’®å¼€å§‹å†’é™©ï¼</div>
                
                <div class="buttons">
                    <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>
                    <button id="resetBtn">é‡æ–°å¼€å§‹</button>
                    <button id="pauseBtn">æš‚åœæ¸¸æˆ</button>
                    <button id="saveScoreBtn" style="background-color: #4CAF50; box-shadow: 0 4px 0 #2E7D32;">ä¿å­˜æˆç»©</button>
                    <button id="clearScoresBtn" style="background-color: #FF5722; box-shadow: 0 4px 0 #D84315;">æ¸…ç©ºè®°å½•</button>
                </div>
                
                <div class="controls">
                    <h3>æ¸¸æˆæ§åˆ¶</h3>
                    <ul>
                        <li>â† â†’ é”®: å·¦å³ç§»åŠ¨</li>
                        <li>ç©ºæ ¼é”®: è·³è·ƒ</li>
                        <li>P é”®: æš‚åœ/ç»§ç»­æ¸¸æˆ</li>
                        <li>R é”®: é‡æ–°å¼€å§‹æ¸¸æˆ</li>
                        <li>F é”®: å¿«é€Ÿä¿å­˜æˆç»©</li>
                    </ul>
                </div>
            </div>
            
            <div class="scores-section">
                <div class="scores-panel">
                    <h3>ğŸ† é«˜åˆ†æ’è¡Œæ¦œ</h3>
                    
                    <div class="score-form">
                        <input type="text" id="playerName" placeholder="è¾“å…¥ä½ çš„åå­—" maxlength="20">
                        <button id="submitScoreBtn">ä¿å­˜å½“å‰æˆç»©</button>
                    </div>
                    
                    <div class="high-scores" id="highScoresList">
                        <!-- åˆ†æ•°è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    
                    <div style="margin-top: 20px; font-size: 0.9rem; color: #aaa; text-align: center;">
                        å½“å‰å·²ä¿å­˜ <span id="scoreCount">0</span> æ¡è®°å½•
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>æ¸¸æˆè¯´æ˜</h3>
            <p>1. æ§åˆ¶é©¬é‡Œå¥¥å·¦å³ç§»åŠ¨å’Œè·³è·ƒï¼Œèº²é¿è˜‘è‡æ•Œäººå’Œå±é™©éšœç¢ã€‚</p>
            <p>2. æ”¶é›†é‡‘è‰²ç¡¬å¸å¯ä»¥è·å¾—åˆ†æ•°ã€‚</p>
            <p>3. åˆ°è¾¾æ——æ†å³å¯è¿›å…¥ä¸‹ä¸€å…³å¡ã€‚</p>
            <p>4. ç¢°åˆ°è˜‘è‡æ•Œäººæˆ–æ‰å…¥é™·é˜±ä¼šæŸå¤±ä¸€æ¡ç”Ÿå‘½ï¼Œç”Ÿå‘½å€¼ä¸º0æ—¶æ¸¸æˆç»“æŸã€‚</p>
            <p>5. å…±8ä¸ªå…³å¡ï¼Œæ¯å…³éš¾åº¦é€’å¢ï¼Œåœ°å›¾ä¸åŒã€‚</p>
            <p>6. æ³¨æ„ç§»åŠ¨å¹³å°ã€å°–åˆºã€ç†”å²©ç­‰æ–°å…ƒç´ ï¼</p>
            <p>7. æ¸¸æˆç»“æŸåå¯ä»¥ä¿å­˜æˆç»©åˆ°æ’è¡Œæ¦œï¼Œä¸æœ‹å‹ä»¬ä¸€è¾ƒé«˜ä¸‹ï¼</p>
        </div>
    </div>

    <script>
        // è·å–Canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            running: false,
            paused: false,
            gameOver: false,
            levelComplete: false,
            gameWin: false,
            score: 0,
            coins: 0,
            lives: 3,
            level: 1,
            gravity: 0.5,
            speed: 3
        };
        
        // é©¬é‡Œå¥¥å¯¹è±¡
        let mario = {
            x: 50,
            y: 300,
            width: 30,
            height: 40,
            velocityX: 0,
            velocityY: 0,
            jumpPower: -12,
            speed: 5,
            onGround: false,
            color: '#E52521',
            faceColor: '#FFB6C1',
            clothesColor: '#2A52BE'
        };
        
        // å…³å¡æ•°æ® - å¢åŠ åˆ°8ä¸ªå…³å¡
        const levelData = {
            1: {
                name: "è‰åœ°ä¸–ç•Œ",
                platforms: [
                    { x: 0, y: 380, width: 800, height: 20, color: '#8B4513', type: 'static' },
                    { x: 100, y: 300, width: 100, height: 20, color: '#8B4513', type: 'static' },
                    { x: 250, y: 250, width: 80, height: 20, color: '#8B4513', type: 'static' },
                    { x: 400, y: 200, width: 100, height: 20, color: '#8B4513', type: 'static' },
                    { x: 550, y: 280, width: 120, height: 20, color: '#8B4513', type: 'static' },
                    { x: 700, y: 320, width: 100, height: 20, color: '#8B4513', type: 'static' }
                ],
                coins: [
                    { x: 150, y: 270, collected: false, radius: 10 },
                    { x: 290, y: 220, collected: false, radius: 10 },
                    { x: 450, y: 170, collected: false, radius: 10 },
                    { x: 600, y: 250, collected: false, radius: 10 },
                    { x: 750, y: 290, collected: false, radius: 10 }
                ],
                enemies: [
                    { x: 200, y: 340, width: 30, height: 30, direction: 1, speed: 1.5, color: '#8A2BE2' },
                    { x: 500, y: 160, width: 30, height: 30, direction: -1, speed: 1.5, color: '#8A2BE2' }
                ],
                movingPlatforms: [],
                spikes: [],
                flagpole: { x: 770, y: 150, width: 10, height: 230, color: '#C0C0C0' }
            },
            
            2: {
                name: "æ´ç©´æ¢é™©",
                platforms: [
                    { x: 0, y: 380, width: 800, height: 20, color: '#696969', type: 'static' },
                    { x: 50, y: 320, width: 80, height: 20, color: '#696969', type: 'static' },
                    { x: 200, y: 280, width: 100, height: 20, color: '#696969', type: 'static' },
                    { x: 350, y: 230, width: 70, height: 20, color: '#696969', type: 'static' },
                    { x: 500, y: 320, width: 90, height: 20, color: '#696969', type: 'static' },
                    { x: 650, y: 260, width: 80, height: 20, color: '#696969', type: 'static' },
                    { x: 300, y: 350, width: 100, height: 20, color: '#696969', type: 'static' }
                ],
                coins: [
                    { x: 90, y: 290, collected: false, radius: 10 },
                    { x: 250, y: 250, collected: false, radius: 10 },
                    { x: 385, y: 200, collected: false, radius: 10 },
                    { x: 545, y: 290, collected: false, radius: 10 },
                    { x: 690, y: 230, collected: false, radius: 10 },
                    { x: 350, y: 320, collected: false, radius: 10 }
                ],
                enemies: [
                    { x: 150, y: 340, width: 30, height: 30, direction: 1, speed: 2.0, color: '#8A2BE2' },
                    { x: 400, y: 200, width: 30, height: 30, direction: -1, speed: 2.0, color: '#8A2BE2' },
                    { x: 600, y: 310, width: 30, height: 30, direction: 1, speed: 2.0, color: '#8A2BE2' }
                ],
                movingPlatforms: [
                    { x: 150, y: 200, width: 80, height: 15, color: '#A9A9A9', direction: 1, speed: 1.5, minX: 150, maxX: 300 }
                ],
                spikes: [
                    { x: 280, y: 360, width: 20, height: 20, color: '#FF0000' },
                    { x: 320, y: 360, width: 20, height: 20, color: '#FF0000' }
                ],
                flagpole: { x: 770, y: 120, width: 10, height: 260, color: '#C0C0C0' }
            },
            
            3: {
                name: "ç©ºä¸­èŠ±å›­",
                platforms: [
                    { x: 0, y: 380, width: 100, height: 20, color: '#228B22', type: 'static' },
                    { x: 200, y: 380, width: 150, height: 20, color: '#228B22', type: 'static' },
                    { x: 450, y: 380, width: 100, height: 20, color: '#228B22', type: 'static' },
                    { x: 650, y: 380, width: 150, height: 20, color: '#228B22', type: 'static' },
                    { x: 100, y: 250, width: 70, height: 20, color: '#228B22', type: 'static' },
                    { x: 300, y: 200, width: 80, height: 20, color: '#228B22', type: 'static' },
                    { x: 500, y: 150, width: 90, height: 20, color: '#228B22', type: 'static' },
                    { x: 200, y: 100, width: 60, height: 20, color: '#228B22', type: 'static' }
                ],
                coins: [
                    { x: 135, y: 220, collected: false, radius: 10 },
                    { x: 340, y: 170, collected: false, radius: 10 },
                    { x: 545, y: 120, collected: false, radius: 10 },
                    { x: 230, y: 70, collected: false, radius: 10 },
                    { x: 700, y: 350, collected: false, radius: 10 },
                    { x: 50, y: 350, collected: false, radius: 10 }
                ],
                enemies: [
                    { x: 250, y: 340, width: 30, height: 30, direction: 1, speed: 2.2, color: '#8A2BE2' },
                    { x: 150, y: 220, width: 30, height: 30, direction: -1, speed: 2.2, color: '#8A2BE2' },
                    { x: 400, y: 130, width: 30, height: 30, direction: 1, speed: 2.2, color: '#8A2BE2' }
                ],
                movingPlatforms: [
                    { x: 600, y: 300, width: 70, height: 15, color: '#32CD32', direction: 1, speed: 2.0, minX: 500, maxX: 700 },
                    { x: 50, y: 180, width: 70, height: 15, color: '#32CD32', direction: -1, speed: 1.8, minX: 50, maxX: 200 }
                ],
                spikes: [
                    { x: 220, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 470, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 320, y: 380, width: 20, height: 20, color: '#FF0000' }
                ],
                flagpole: { x: 770, y: 80, width: 10, height: 300, color: '#C0C0C0' }
            },
            
            4: {
                name: "ç«å±±ç†”å²©",
                platforms: [
                    { x: 0, y: 380, width: 70, height: 20, color: '#8B0000', type: 'static' },
                    { x: 150, y: 380, width: 100, height: 20, color: '#8B0000', type: 'static' },
                    { x: 350, y: 380, width: 120, height: 20, color: '#8B0000', type: 'static' },
                    { x: 550, y: 380, width: 100, height: 20, color: '#8B0000', type: 'static' },
                    { x: 700, y: 380, width: 100, height: 20, color: '#8B0000', type: 'static' },
                    { x: 80, y: 300, width: 60, height: 20, color: '#8B0000', type: 'static' },
                    { x: 250, y: 280, width: 70, height: 20, color: '#8B0000', type: 'static' },
                    { x: 450, y: 230, width: 80, height: 20, color: '#8B0000', type: 'static' },
                    { x: 600, y: 200, width: 90, height: 20, color: '#8B0000', type: 'static' },
                    { x: 300, y: 150, width: 60, height: 20, color: '#8B0000', type: 'static' }
                ],
                coins: [
                    { x: 110, y: 270, collected: false, radius: 10 },
                    { x: 285, y: 250, collected: false, radius: 10 },
                    { x: 490, y: 200, collected: false, radius: 10 },
                    { x: 645, y: 170, collected: false, radius: 10 },
                    { x: 330, y: 120, collected: false, radius: 10 },
                    { x: 195, y: 350, collected: false, radius: 10 },
                    { x: 400, y: 350, collected: false, radius: 10 },
                    { x: 620, y: 350, collected: false, radius: 10 }
                ],
                enemies: [
                    { x: 180, y: 340, width: 30, height: 30, direction: 1, speed: 2.5, color: '#8A2BE2' },
                    { x: 320, y: 250, width: 30, height: 30, direction: -1, speed: 2.5, color: '#8A2BE2' },
                    { x: 500, y: 200, width: 30, height: 30, direction: 1, speed: 2.5, color: '#8A2BE2' },
                    { x: 650, y: 160, width: 30, height: 30, direction: -1, speed: 2.5, color: '#8A2BE2' }
                ],
                movingPlatforms: [
                    { x: 200, y: 200, width: 80, height: 15, color: '#FF4500', direction: 1, speed: 2.2, minX: 200, maxX: 400 },
                    { x: 500, y: 100, width: 80, height: 15, color: '#FF4500', direction: -1, speed: 2.0, minX: 400, maxX: 600 }
                ],
                spikes: [
                    { x: 170, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 220, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 400, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 450, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 600, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 650, y: 380, width: 20, height: 20, color: '#FF0000' }
                ],
                lava: [
                    { x: 70, y: 380, width: 80, height: 20, color: '#FF4500' },
                    { x: 250, y: 380, width: 100, height: 20, color: '#FF4500' },
                    { x: 470, y: 380, width: 80, height: 20, color: '#FF4500' }
                ],
                flagpole: { x: 770, y: 100, width: 10, height: 280, color: '#C0C0C0' }
            },
            
            5: {
                name: "å†°é›ªä¸–ç•Œ",
                platforms: [
                    { x: 0, y: 380, width: 150, height: 20, color: '#B0E0E6', type: 'static' },
                    { x: 200, y: 350, width: 120, height: 20, color: '#B0E0E6', type: 'static' },
                    { x: 400, y: 320, width: 100, height: 20, color: '#B0E0E6', type: 'static' },
                    { x: 600, y: 290, width: 150, height: 20, color: '#B0E0E6', type: 'static' },
                    { x: 100, y: 250, width: 80, height: 20, color: '#B0E0E6', type: 'static' },
                    { x: 300, y: 220, width: 90, height: 20, color: '#B0E0E6', type: 'static' },
                    { x: 500, y: 190, width: 70, height: 20, color: '#B0E0E6', type: 'static' },
                    { x: 700, y: 160, width: 100, height: 20, color: '#B0E0E6', type: 'static' },
                    { x: 150, y: 120, width: 60, height: 20, color: '#B0E0E6', type: 'static' },
                    { x: 350, y: 90, width: 80, height: 20, color: '#B0E0E6', type: 'static' }
                ],
                coins: [
                    { x: 75, y: 220, collected: false, radius: 10 },
                    { x: 345, y: 190, collected: false, radius: 10 },
                    { x: 535, y: 160, collected: false, radius: 10 },
                    { x: 750, y: 130, collected: false, radius: 10 },
                    { x: 175, y: 90, collected: false, radius: 10 },
                    { x: 390, y: 60, collected: false, radius: 10 },
                    { x: 650, y: 340, collected: false, radius: 10 },
                    { x: 250, y: 320, collected: false, radius: 10 }
                ],
                enemies: [
                    { x: 220, y: 310, width: 30, height: 30, direction: 1, speed: 2.3, color: '#8A2BE2' },
                    { x: 450, y: 260, width: 30, height: 30, direction: -1, speed: 2.3, color: '#8A2BE2' },
                    { x: 650, y: 230, width: 30, height: 30, direction: 1, speed: 2.3, color: '#8A2BE2' },
                    { x: 180, y: 90, width: 30, height: 30, direction: -1, speed: 2.3, color: '#8A2BE2' }
                ],
                movingPlatforms: [
                    { x: 550, y: 350, width: 70, height: 15, color: '#ADD8E6', direction: 1, speed: 2.0, minX: 500, maxX: 700 },
                    { x: 200, y: 180, width: 70, height: 15, color: '#ADD8E6', direction: -1, speed: 1.8, minX: 150, maxX: 300 }
                ],
                iceBlocks: [
                    { x: 50, y: 300, width: 40, height: 40, color: '#87CEEB', slippery: true },
                    { x: 300, y: 270, width: 40, height: 40, color: '#87CEEB', slippery: true },
                    { x: 550, y: 240, width: 40, height: 40, color: '#87CEEB', slippery: true }
                ],
                flagpole: { x: 770, y: 60, width: 10, height: 320, color: '#C0C0C0' }
            },
            
            6: {
                name: "æ²™æ¼ é—è¿¹",
                platforms: [
                    { x: 0, y: 380, width: 100, height: 20, color: '#D2691E', type: 'static' },
                    { x: 150, y: 360, width: 120, height: 20, color: '#D2691E', type: 'static' },
                    { x: 350, y: 340, width: 100, height: 20, color: '#D2691E', type: 'static' },
                    { x: 550, y: 320, width: 120, height: 20, color: '#D2691E', type: 'static' },
                    { x: 700, y: 300, width: 100, height: 20, color: '#D2691E', type: 'static' },
                    { x: 100, y: 240, width: 80, height: 20, color: '#D2691E', type: 'static' },
                    { x: 300, y: 220, width: 90, height: 20, color: '#D2691E', type: 'static' },
                    { x: 500, y: 200, width: 70, height: 20, color: '#D2691E', type: 'static' },
                    { x: 650, y: 180, width: 100, height: 20, color: '#D2691E', type: 'static' },
                    { x: 200, y: 140, width: 60, height: 20, color: '#D2691E', type: 'static' },
                    { x: 400, y: 120, width: 80, height: 20, color: '#D2691E', type: 'static' }
                ],
                coins: [
                    { x: 190, y: 320, collected: false, radius: 10 },
                    { x: 400, y: 300, collected: false, radius: 10 },
                    { x: 610, y: 280, collected: false, radius: 10 },
                    { x: 140, y: 200, collected: false, radius: 10 },
                    { x: 350, y: 180, collected: false, radius: 10 },
                    { x: 550, y: 160, collected: false, radius: 10 },
                    { x: 700, y: 140, collected: false, radius: 10 },
                    { x: 230, y: 100, collected: false, radius: 10 },
                    { x: 450, y: 80, collected: false, radius: 10 }
                ],
                enemies: [
                    { x: 180, y: 340, width: 30, height: 30, direction: 1, speed: 2.4, color: '#8A2BE2' },
                    { x: 380, y: 320, width: 30, height: 30, direction: -1, speed: 2.4, color: '#8A2BE2' },
                    { x: 580, y: 300, width: 30, height: 30, direction: 1, speed: 2.4, color: '#8A2BE2' },
                    { x: 120, y: 220, width: 30, height: 30, direction: -1, speed: 2.4, color: '#8A2BE2' },
                    { x: 320, y: 200, width: 30, height: 30, direction: 1, speed: 2.4, color: '#8A2BE2' }
                ],
                movingPlatforms: [
                    { x: 250, y: 280, width: 70, height: 15, color: '#CD853F', direction: 1, speed: 2.2, minX: 200, maxX: 400 },
                    { x: 450, y: 150, width: 70, height: 15, color: '#CD853F', direction: -1, speed: 2.1, minX: 400, maxX: 600 }
                ],
                quicksand: [
                    { x: 500, y: 380, width: 80, height: 20, color: '#DEB887', slow: true },
                    { x: 200, y: 380, width: 100, height: 20, color: '#DEB887', slow: true }
                ],
                flagpole: { x: 770, y: 80, width: 10, height: 300, color: '#C0C0C0' }
            },
            
            7: {
                name: "é»‘å¤œåŸå ¡",
                platforms: [
                    { x: 0, y: 380, width: 80, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 150, y: 380, width: 100, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 350, y: 380, width: 120, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 550, y: 380, width: 100, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 700, y: 380, width: 100, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 50, y: 300, width: 70, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 250, y: 280, width: 80, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 450, y: 260, width: 90, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 650, y: 240, width: 70, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 100, y: 180, width: 60, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 300, y: 160, width: 80, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 500, y: 140, width: 70, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 700, y: 120, width: 100, height: 20, color: '#2F4F4F', type: 'static' }
                ],
                coins: [
                    { x: 85, y: 260, collected: false, radius: 10 },
                    { x: 290, y: 240, collected: false, radius: 10 },
                    { x: 495, y: 220, collected: false, radius: 10 },
                    { x: 685, y: 200, collected: false, radius: 10 },
                    { x: 130, y: 140, collected: false, radius: 10 },
                    { x: 340, y: 120, collected: false, radius: 10 },
                    { x: 540, y: 100, collected: false, radius: 10 },
                    { x: 750, y: 80, collected: false, radius: 10 },
                    { x: 400, y: 340, collected: false, radius: 10 },
                    { x: 600, y: 320, collected: false, radius: 10 }
                ],
                enemies: [
                    { x: 180, y: 340, width: 30, height: 30, direction: 1, speed: 2.6, color: '#8A2BE2' },
                    { x: 380, y: 320, width: 30, height: 30, direction: -1, speed: 2.6, color: '#8A2BE2' },
                    { x: 580, y: 300, width: 30, height: 30, direction: 1, speed: 2.6, color: '#8A2BE2' },
                    { x: 120, y: 160, width: 30, height: 30, direction: -1, speed: 2.6, color: '#8A2BE2' },
                    { x: 320, y: 140, width: 30, height: 30, direction: 1, speed: 2.6, color: '#8A2BE2' },
                    { x: 520, y: 120, width: 30, height: 30, direction: -1, speed: 2.6, color: '#8A2BE2' }
                ],
                movingPlatforms: [
                    { x: 200, y: 220, width: 80, height: 15, color: '#708090', direction: 1, speed: 2.4, minX: 150, maxX: 350 },
                    { x: 400, y: 200, width: 80, height: 15, color: '#708090', direction: -1, speed: 2.3, minX: 350, maxX: 550 },
                    { x: 600, y: 180, width: 80, height: 15, color: '#708090', direction: 1, speed: 2.5, minX: 550, maxX: 750 }
                ],
                spikes: [
                    { x: 160, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 310, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 460, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 610, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 60, y: 300, width: 20, height: 20, color: '#FF0000' },
                    { x: 350, y: 260, width: 20, height: 20, color: '#FF0000' },
                    { x: 520, y: 140, width: 20, height: 20, color: '#FF0000' }
                ],
                flagpole: { x: 770, y: 50, width: 10, height: 330, color: '#C0C0C0' }
            },
            
            8: {
                name: "æœ€ç»ˆå ¡å’",
                platforms: [
                    { x: 0, y: 380, width: 60, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 150, y: 380, width: 80, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 300, y: 380, width: 70, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 450, y: 380, width: 60, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 600, y: 380, width: 90, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 750, y: 380, width: 50, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 50, y: 300, width: 50, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 200, y: 280, width: 60, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 350, y: 240, width: 70, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 500, y: 200, width: 60, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 650, y: 160, width: 70, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 100, y: 120, width: 60, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 300, y: 100, width: 70, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 550, y: 80, width: 60, height: 20, color: '#2F4F4F', type: 'static' },
                    { x: 700, y: 60, width: 70, height: 20, color: '#2F4F4F', type: 'static' }
                ],
                coins: [
                    { x: 75, y: 270, collected: false, radius: 10 },
                    { x: 230, y: 250, collected: false, radius: 10 },
                    { x: 385, y: 210, collected: false, radius: 10 },
                    { x: 530, y: 170, collected: false, radius: 10 },
                    { x: 685, y: 130, collected: false, radius: 10 },
                    { x: 130, y: 90, collected: false, radius: 10 },
                    { x: 335, y: 70, collected: false, radius: 10 },
                    { x: 580, y: 50, collected: false, radius: 10 },
                    { x: 750, y: 30, collected: false, radius: 10 },
                    { x: 185, y: 350, collected: false, radius: 10 },
                    { x: 480, y: 350, collected: false, radius: 10 },
                    { x: 650, y: 330, collected: false, radius: 10 }
                ],
                enemies: [
                    { x: 180, y: 340, width: 30, height: 30, direction: 1, speed: 2.8, color: '#8A2BE2' },
                    { x: 330, y: 220, width: 30, height: 30, direction: -1, speed: 2.8, color: '#8A2BE2' },
                    { x: 480, y: 170, width: 30, height: 30, direction: 1, speed: 2.8, color: '#8A2BE2' },
                    { x: 630, y: 130, width: 30, height: 30, direction: -1, speed: 2.8, color: '#8A2BE2' },
                    { x: 150, y: 90, width: 30, height: 30, direction: 1, speed: 2.8, color: '#8A2BE2' },
                    { x: 320, y: 70, width: 30, height: 30, direction: -1, speed: 2.8, color: '#8A2BE2' },
                    { x: 570, y: 50, width: 30, height: 30, direction: 1, speed: 2.8, color: '#8A2BE2' },
                    { x: 720, y: 30, width: 30, height: 30, direction: -1, speed: 2.8, color: '#8A2BE2' }
                ],
                movingPlatforms: [
                    { x: 400, y: 320, width: 70, height: 15, color: '#708090', direction: 1, speed: 2.5, minX: 300, maxX: 500 },
                    { x: 100, y: 180, width: 70, height: 15, color: '#708090', direction: -1, speed: 2.3, minX: 50, maxX: 250 },
                    { x: 600, y: 100, width: 70, height: 15, color: '#708090', direction: 1, speed: 2.7, minX: 550, maxX: 700 }
                ],
                spikes: [
                    { x: 160, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 310, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 460, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 610, y: 380, width: 20, height: 20, color: '#FF0000' },
                    { x: 60, y: 300, width: 20, height: 20, color: '#FF0000' },
                    { x: 350, y: 240, width: 20, height: 20, color: '#FF0000' },
                    { x: 520, y: 200, width: 20, height: 20, color: '#FF0000' },
                    { x: 670, y: 160, width: 20, height: 20, color: '#FF0000' },
                    { x: 120, y: 120, width: 20, height: 20, color: '#FF0000' }
                ],
                flagpole: { x: 770, y: 30, width: 10, height: 350, color: '#C0C0C0' }
            }
        };
        
        // å½“å‰å…³å¡æ•°æ®
        let platforms = [];
        let coins = [];
        let enemies = [];
        let movingPlatforms = [];
        let spikes = [];
        let lava = [];
        let iceBlocks = [];
        let quicksand = [];
        let flagpole = {};
        
        // åˆ†æ•°è®°å½•ç³»ç»Ÿ
        let highScores = [];
        const MAX_SCORES = 10;
        
        // åˆå§‹åŒ–åˆ†æ•°è®°å½•
        function initScores() {
            const savedScores = localStorage.getItem('marioHighScores');
            if (savedScores) {
                highScores = JSON.parse(savedScores);
            } else {
                highScores = [
                    { name: "è¶…çº§ç©å®¶", score: 15000, level: 8, date: "2023-10-01" },
                    { name: "é©¬é‡Œå¥¥å¤§å¸ˆ", score: 12000, level: 7, date: "2023-10-02" },
                    { name: "è·³è·ƒé«˜æ‰‹", score: 10000, level: 6, date: "2023-10-03" },
                    { name: "é‡‘å¸æ”¶è—å®¶", score: 8000, level: 5, date: "2023-10-04" },
                    { name: "æ–°æ‰‹ç©å®¶", score: 5000, level: 4, date: "2023-10-05" }
                ];
                saveScores();
            }
            displayScores();
        }
        
        // ä¿å­˜åˆ†æ•°åˆ°æœ¬åœ°å­˜å‚¨
        function saveScores() {
            localStorage.setItem('marioHighScores', JSON.stringify(highScores));
            updateScoreCount();
        }
        
        // æ˜¾ç¤ºåˆ†æ•°
        function displayScores() {
            const scoresList = document.getElementById('highScoresList');
            scoresList.innerHTML = '';
            
            // æŒ‰åˆ†æ•°æ’åº
            highScores.sort((a, b) => b.score - a.score);
            
            // åªæ˜¾ç¤ºå‰MAX_SCORESå
            const displayScores = highScores.slice(0, MAX_SCORES);
            
            displayScores.forEach((score, index) => {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                
                const rank = document.createElement('div');
                rank.className = 'score-rank';
                rank.textContent = `#${index + 1}`;
                
                const name = document.createElement('div');
                name.className = 'score-name';
                name.textContent = score.name;
                
                const scoreValue = document.createElement('div');
                scoreValue.className = 'score-value';
                scoreValue.textContent = score.score.toLocaleString();
                
                const level = document.createElement('div');
                level.className = 'score-level';
                level.textContent = `å…³å¡ ${score.level}`;
                
                scoreItem.appendChild(rank);
                scoreItem.appendChild(name);
                scoreItem.appendChild(level);
                scoreItem.appendChild(scoreValue);
                
                scoresList.appendChild(scoreItem);
            });
            
            updateScoreCount();
        }
        
        // æ›´æ–°åˆ†æ•°è®¡æ•°
        function updateScoreCount() {
            document.getElementById('scoreCount').textContent = highScores.length;
        }
        
        // æ·»åŠ æ–°åˆ†æ•°
        function addScore(name, score, level) {
            const date = new Date().toISOString().split('T')[0]; // è·å–å½“å‰æ—¥æœŸ
            const newScore = { name, score, level, date };
            
            highScores.push(newScore);
            
            // æŒ‰åˆ†æ•°æ’åºå¹¶ä¿ç•™å‰MAX_SCORESå
            highScores.sort((a, b) => b.score - a.score);
            if (highScores.length > MAX_SCORES) {
                highScores = highScores.slice(0, MAX_SCORES);
            }
            
            saveScores();
            displayScores();
            
            // æ˜¾ç¤ºæ·»åŠ æˆåŠŸæ¶ˆæ¯
            document.getElementById('gameStatus').textContent = `æ­å–œ ${name}ï¼ä½ çš„æˆç»©å·²ä¿å­˜åˆ°æ’è¡Œæ¦œç¬¬ ${highScores.findIndex(s => s.name === name && s.score === score) + 1} åï¼`;
        }
        
        // æ¸…ç©ºåˆ†æ•°è®°å½•
        function clearScores() {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åˆ†æ•°è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼")) {
                highScores = [];
                saveScores();
                displayScores();
                document.getElementById('gameStatus').textContent = "åˆ†æ•°è®°å½•å·²æ¸…ç©ºï¼";
            }
        }
        
        // æŒ‰é”®çŠ¶æ€
        let keys = {};
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            gameState.running = true;
            gameState.gameOver = false;
            gameState.levelComplete = false;
            gameState.gameWin = false;
            gameState.score = 0;
            gameState.coins = 0;
            gameState.lives = 3;
            gameState.level = 1;
            gameState.speed = 3;
            
            // é‡ç½®é©¬é‡Œå¥¥
            mario.x = 50;
            mario.y = 300;
            mario.velocityX = 0;
            mario.velocityY = 0;
            
            // åŠ è½½ç¬¬ä¸€å…³
            loadLevel(1);
            
            updateStats();
            document.getElementById('gameStatus').textContent = "æ¸¸æˆå¼€å§‹ï¼èº²é¿æ•Œäººï¼Œæ”¶é›†é‡‘å¸ï¼Œåˆ°è¾¾æ——æ†ï¼";
            document.getElementById('playerName').value = "";
        }
        
        // åŠ è½½æŒ‡å®šå…³å¡
        function loadLevel(levelNum) {
            const level = levelData[levelNum];
            
            // æ›´æ–°å…³å¡æ˜¾ç¤º
            document.getElementById('levelName').textContent = level.name;
            
            // è®¾ç½®å…³å¡æ•°æ®
            platforms = JSON.parse(JSON.stringify(level.platforms || []));
            coins = JSON.parse(JSON.stringify(level.coins || []));
            enemies = JSON.parse(JSON.stringify(level.enemies || []));
            movingPlatforms = JSON.parse(JSON.stringify(level.movingPlatforms || []));
            spikes = JSON.parse(JSON.stringify(level.spikes || []));
            lava = JSON.parse(JSON.stringify(level.lava || []));
            iceBlocks = JSON.parse(JSON.stringify(level.iceBlocks || []));
            quicksand = JSON.parse(JSON.stringify(level.quicksand || []));
            flagpole = JSON.parse(JSON.stringify(level.flagpole));
            
            // è®¾ç½®é©¬é‡Œå¥¥åˆå§‹ä½ç½®
            mario.x = 50;
            mario.y = levelNum >= 5 ? 350 : 300;
        }
        
        // å¼€å§‹æ–°å…³å¡
        function nextLevel() {
            gameState.level++;
            
            if (gameState.level > 8) {
                gameWin();
                return;
            }
            
            gameState.levelComplete = false;
            gameState.speed += 0.5;
            
            // åŠ è½½ä¸‹ä¸€å…³
            loadLevel(gameState.level);
            
            // é‡ç½®é©¬é‡Œå¥¥ä½ç½®
            mario.x = 50;
            mario.y = gameState.level >= 5 ? 350 : 300;
            mario.velocityX = 0;
            mario.velocityY = 0;
            
            updateStats();
            document.getElementById('gameStatus').textContent = `è¿›å…¥ç¬¬ ${gameState.level} å…³ï¼š${levelData[gameState.level].name}ï¼`;
            
            // æ’­æ”¾è¿‡å…³éŸ³æ•ˆï¼ˆæ¨¡æ‹Ÿï¼‰
            playLevelCompleteSound();
        }
        
        // æ›´æ–°æ¸¸æˆç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
        function updateStats() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('coins').textContent = gameState.coins;
            document.getElementById('lives').textContent = gameState.lives;
            document.getElementById('level').textContent = gameState.level;
        }
        
        // ç»˜åˆ¶é©¬é‡Œå¥¥
        function drawMario() {
            // é©¬é‡Œå¥¥çš„èº«ä½“
            ctx.fillStyle = mario.color;
            ctx.fillRect(mario.x, mario.y, mario.width, mario.height);
            
            // é©¬é‡Œå¥¥çš„è„¸
            ctx.fillStyle = mario.faceColor;
            ctx.fillRect(mario.x + 5, mario.y + 5, mario.width - 10, 15);
            
            // é©¬é‡Œå¥¥çš„å¸½å­
            ctx.fillStyle = mario.color;
            ctx.fillRect(mario.x, mario.y - 5, mario.width, 10);
            
            // é©¬é‡Œå¥¥çš„è£¤å­
            ctx.fillStyle = mario.clothesColor;
            ctx.fillRect(mario.x, mario.y + 25, mario.width, 15);
            
            // é©¬é‡Œå¥¥çš„çœ¼ç›
            ctx.fillStyle = 'white';
            ctx.fillRect(mario.x + 8, mario.y + 8, 5, 5);
            ctx.fillRect(mario.x + 17, mario.y + 8, 5, 5);
            
            // é©¬é‡Œå¥¥çš„å˜´å·´
            ctx.fillStyle = 'black';
            ctx.fillRect(mario.x + 10, mario.y + 16, 10, 2);
        }
        
        // ç»˜åˆ¶å¹³å°
        function drawPlatforms() {
            platforms.forEach(platform => {
                ctx.fillStyle = platform.color;
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                
                // æ·»åŠ å¹³å°çº¹ç†
                let textureColor;
                switch(platform.color) {
                    case '#8B4513': textureColor = '#A0522D'; break;
                    case '#696969': textureColor = '#808080'; break;
                    case '#228B22': textureColor = '#32CD32'; break;
                    case '#8B0000': textureColor = '#B22222'; break;
                    case '#B0E0E6': textureColor = '#87CEEB'; break;
                    case '#D2691E': textureColor = '#CD853F'; break;
                    default: textureColor = '#556B2F';
                }
                
                ctx.fillStyle = textureColor;
                for (let i = 0; i < platform.width; i += 10) {
                    ctx.fillRect(platform.x + i, platform.y, 5, platform.height);
                }
            });
        }
        
        // ç»˜åˆ¶ç§»åŠ¨å¹³å°
        function drawMovingPlatforms() {
            movingPlatforms.forEach(platform => {
                ctx.fillStyle = platform.color;
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                
                // ç§»åŠ¨å¹³å°çº¹ç†
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                for (let i = 0; i < platform.width; i += 15) {
                    ctx.fillRect(platform.x + i, platform.y, 8, platform.height);
                }
            });
        }
        
        // ç»˜åˆ¶é‡‘å¸
        function drawCoins() {
            coins.forEach(coin => {
                if (!coin.collected) {
                    // é‡‘å¸é¢œè‰²æ¸å˜
                    const gradient = ctx.createRadialGradient(
                        coin.x, coin.y, 0,
                        coin.x, coin.y, coin.radius
                    );
                    gradient.addColorStop(0, '#FFD700');
                    gradient.addColorStop(1, '#FFA500');
                    
                    ctx.beginPath();
                    ctx.arc(coin.x, coin.y, coin.radius, 0, Math.PI * 2);
                    ctx.fillStyle = gradient;
                    ctx.fill();
                    
                    // é‡‘å¸é«˜å…‰
                    ctx.beginPath();
                    ctx.arc(coin.x - 3, coin.y - 3, 3, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.fill();
                }
            });
        }
        
        // ç»˜åˆ¶æ•Œäºº
        function drawEnemies() {
            enemies.forEach(enemy => {
                // æ•Œäººèº«ä½“
                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.ellipse(
                    enemy.x + enemy.width/2, 
                    enemy.y + enemy.height/2, 
                    enemy.width/2, 
                    enemy.height/2, 
                    0, 0, Math.PI * 2
                );
                ctx.fill();
                
                // æ•Œäººæ–‘ç‚¹
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.ellipse(
                    enemy.x + enemy.width/2, 
                    enemy.y + enemy.height/3, 
                    4, 4, 0, 0, Math.PI * 2
                );
                ctx.fill();
                
                // æ•Œäººçœ¼ç›
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.ellipse(
                    enemy.x + enemy.width/3, 
                    enemy.y + enemy.height/2, 
                    3, 5, 0, 0, Math.PI * 2
                );
                ctx.fill();
                
                ctx.beginPath();
                ctx.ellipse(
                    enemy.x + 2*enemy.width/3, 
                    enemy.y + enemy.height/2, 
                    3, 5, 0, 0, Math.PI * 2
                );
                ctx.fill();
                
                // æ•Œäººç³å­”
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.ellipse(
                    enemy.x + enemy.width/3, 
                    enemy.y + enemy.height/2, 
                    1.5, 2.5, 0, 0, Math.PI * 2
                );
                ctx.fill();
                
                ctx.beginPath();
                ctx.ellipse(
                    enemy.x + 2*enemy.width/3, 
                    enemy.y + enemy.height/2, 
                    1.5, 2.5, 0, 0, Math.PI * 2
                );
                ctx.fill();
            });
        }
        
        // ç»˜åˆ¶å°–åˆº
        function drawSpikes() {
            spikes.forEach(spike => {
                ctx.fillStyle = spike.color;
                
                // ç»˜åˆ¶ä¸‰è§’å½¢å°–åˆº
                ctx.beginPath();
                ctx.moveTo(spike.x + spike.width/2, spike.y);
                ctx.lineTo(spike.x, spike.y + spike.height);
                ctx.lineTo(spike.x + spike.width, spike.y + spike.height);
                ctx.closePath();
                ctx.fill();
            });
        }
        
        // ç»˜åˆ¶ç†”å²©
        function drawLava() {
            lava.forEach(lavaSection => {
                // ç†”å²©æ¸å˜
                const gradient = ctx.createLinearGradient(
                    lavaSection.x, lavaSection.y,
                    lavaSection.x, lavaSection.y + lavaSection.height
                );
                gradient.addColorStop(0, '#FF4500');
                gradient.addColorStop(1, '#8B0000');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(lavaSection.x, lavaSection.y, lavaSection.width, lavaSection.height);
                
                // ç†”å²©æ°”æ³¡
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                for (let i = 0; i < 3; i++) {
                    const bubbleX = lavaSection.x + Math.random() * lavaSection.width;
                    const bubbleY = lavaSection.y + Math.random() * lavaSection.height;
                    const bubbleRadius = Math.random() * 5 + 2;
                    
                    ctx.beginPath();
                    ctx.arc(bubbleX, bubbleY, bubbleRadius, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }
        
        // ç»˜åˆ¶å†°ç –
        function drawIceBlocks() {
            iceBlocks.forEach(ice => {
                ctx.fillStyle = ice.color;
                ctx.fillRect(ice.x, ice.y, ice.width, ice.height);
                
                // å†°ç –åå…‰æ•ˆæœ
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fillRect(ice.x, ice.y, ice.width/2, ice.height/2);
            });
        }
        
        // ç»˜åˆ¶æµæ²™
        function drawQuicksand() {
            quicksand.forEach(sand => {
                ctx.fillStyle = sand.color;
                ctx.fillRect(sand.x, sand.y, sand.width, sand.height);
                
                // æµæ²™çº¹ç†
                ctx.fillStyle = 'rgba(139, 69, 19, 0.5)';
                for (let i = 0; i < sand.width; i += 15) {
                    ctx.fillRect(sand.x + i, sand.y, 8, sand.height);
                }
            });
        }
        
        // ç»˜åˆ¶æ——æ†
        function drawFlagpole() {
            // æ——æ†
            ctx.fillStyle = flagpole.color;
            ctx.fillRect(flagpole.x, flagpole.y, flagpole.width, flagpole.height);
            
            // æ——æ†é¡¶éƒ¨
            ctx.beginPath();
            ctx.arc(flagpole.x + flagpole.width/2, flagpole.y, 10, 0, Math.PI * 2);
            ctx.fillStyle = '#FFD700';
            ctx.fill();
            
            // æ——å¸œ
            const flagColor = gameState.level === 8 ? '#FFD700' : '#E52521';
            ctx.fillStyle = flagColor;
            ctx.fillRect(flagpole.x - 40, flagpole.y + 10, 40, 30);
            
            // æ——å¸œå›¾æ¡ˆï¼ˆæœ€ç»ˆå…³å¡ç‰¹æ®Šæ——å¸œï¼‰
            if (gameState.level === 8) {
                ctx.fillStyle = '#E52521';
                ctx.beginPath();
                ctx.arc(flagpole.x - 20, flagpole.y + 25, 8, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // ç»˜åˆ¶èƒŒæ™¯
        function drawBackground() {
            // æ ¹æ®å…³å¡ç»˜åˆ¶ä¸åŒèƒŒæ™¯
            let skyColor, groundColor, cloudColor;
            
            switch(gameState.level) {
                case 1: skyColor = '#87CEEB'; groundColor = '#7CFC00'; cloudColor = 'white'; break;
                case 2: skyColor = '#1E1E1E'; groundColor = '#4A4A4A'; cloudColor = '#696969'; break;
                case 3: skyColor = '#87CEEB'; groundColor = '#32CD32'; cloudColor = 'white'; break;
                case 4: skyColor = '#8B0000'; groundColor = '#A52A2A'; cloudColor = '#FF6347'; break;
                case 5: skyColor = '#87CEEB'; groundColor = '#F0F8FF'; cloudColor = 'white'; break;
                case 6: skyColor = '#FFD700'; groundColor = '#F4A460'; cloudColor = '#FFE4B5'; break;
                case 7: skyColor = '#191970'; groundColor = '#2F4F4F'; cloudColor = '#708090'; break;
                case 8: skyColor = '#000000'; groundColor = '#2F4F4F'; cloudColor = '#708090'; break;
            }
            
            // å¤©ç©º
            ctx.fillStyle = skyColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // äº‘æœµ
            if (gameState.level !== 2 && gameState.level !== 7 && gameState.level !== 8) {
                ctx.fillStyle = cloudColor;
                ctx.beginPath();
                ctx.arc(100, 60, 20, 0, Math.PI * 2);
                ctx.arc(130, 50, 25, 0, Math.PI * 2);
                ctx.arc(160, 60, 20, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(500, 80, 20, 0, Math.PI * 2);
                ctx.arc(530, 70, 25, 0, Math.PI * 2);
                ctx.arc(560, 80, 20, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // æ˜Ÿæ˜Ÿï¼ˆå¤œæ™šå…³å¡ï¼‰
            if (gameState.level === 7 || gameState.level === 8) {
                ctx.fillStyle = 'white';
                for (let i = 0; i < 50; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * 200;
                    const size = Math.random() * 2 + 1;
                    ctx.fillRect(x, y, size, size);
                }
                
                // æœˆäº®
                if (gameState.level === 7) {
                    ctx.fillStyle = '#F0F0F0';
                    ctx.beginPath();
                    ctx.arc(700, 60, 30, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = skyColor;
                    ctx.beginPath();
                    ctx.arc(715, 50, 25, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // åœ°é¢
            ctx.fillStyle = groundColor;
            ctx.fillRect(0, 350, canvas.width, 50);
            
            // è‰å¶
            if (gameState.level === 1 || gameState.level === 3) {
                ctx.fillStyle = gameState.level === 1 ? '#32CD32' : '#228B22';
                for (let i = 0; i < canvas.width; i += 10) {
                    ctx.beginPath();
                    ctx.moveTo(i, 350);
                    ctx.lineTo(i + 5, 330);
                    ctx.lineTo(i + 10, 350);
                    ctx.closePath();
                    ctx.fill();
                }
            }
            
            // é›ªèŠ±ï¼ˆå†°é›ªä¸–ç•Œï¼‰
            if (gameState.level === 5) {
                ctx.fillStyle = 'white';
                for (let i = 0; i < 30; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * 350;
                    const size = Math.random() * 3 + 1;
                    ctx.fillRect(x, y, size, size);
                }
            }
        }
        
        // ç»˜åˆ¶æ¸¸æˆ
        function drawGame() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ¸¸æˆå…ƒç´ 
            drawBackground();
            drawPlatforms();
            drawMovingPlatforms();
            drawCoins();
            drawEnemies();
            drawSpikes();
            if (gameState.level === 4) drawLava();
            if (gameState.level === 5) drawIceBlocks();
            if (gameState.level === 6) drawQuicksand();
            drawFlagpole();
            drawMario();
            
            // ç»˜åˆ¶æ¸¸æˆçŠ¶æ€
            if (gameState.paused) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.font = 'bold 40px Arial';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.fillText('æ¸¸æˆæš‚åœ', canvas.width / 2, canvas.height / 2 - 20);
                
                ctx.font = '20px Arial';
                ctx.fillText('æŒ‰ P é”®ç»§ç»­', canvas.width / 2, canvas.height / 2 + 30);
            }
            
            if (gameState.gameOver) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.font = 'bold 40px Arial';
                ctx.fillStyle = 'red';
                ctx.textAlign = 'center';
                ctx.fillText('æ¸¸æˆç»“æŸ', canvas.width / 2, canvas.height / 2 - 50);
                
                ctx.font = '25px Arial';
                ctx.fillStyle = 'white';
                ctx.fillText(`æœ€ç»ˆå¾—åˆ†: ${gameState.score}`, canvas.width / 2, canvas.height / 2);
                ctx.fillText(`é€šå…³å…³å¡: ${gameState.level - 1}`, canvas.width / 2, canvas.height / 2 + 40);
                ctx.fillText('è¾“å…¥åå­—ä¿å­˜æˆç»©', canvas.width / 2, canvas.height / 2 + 90);
            }
            
            if (gameState.levelComplete) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.font = 'bold 40px Arial';
                ctx.fillStyle = '#FFD700';
                ctx.textAlign = 'center';
                ctx.fillText('å…³å¡å®Œæˆ!', canvas.width / 2, canvas.height / 2 - 20);
                
                if (gameState.level < 8) {
                    ctx.font = '25px Arial';
                    ctx.fillStyle = 'white';
                    ctx.fillText(`å‡†å¤‡è¿›å…¥ç¬¬ ${gameState.level + 1} å…³: ${levelData[gameState.level + 1].name}`, canvas.width / 2, canvas.height / 2 + 30);
                }
            }
            
            if (gameState.gameWin) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.font = 'bold 40px Arial';
                ctx.fillStyle = '#FFD700';
                ctx.textAlign = 'center';
                ctx.fillText('æ­å–œé€šå…³!', canvas.width / 2, canvas.height / 2 - 50);
                
                ctx.font = '30px Arial';
                ctx.fillStyle = 'white';
                ctx.fillText(`æœ€ç»ˆå¾—åˆ†: ${gameState.score}`, canvas.width / 2, canvas.height / 2);
                ctx.fillText('ä½ å®Œæˆäº†æ‰€æœ‰å…³å¡!', canvas.width / 2, canvas.height / 2 + 50);
                ctx.fillText('è¾“å…¥åå­—ä¿å­˜æˆç»©', canvas.width / 2, canvas.height / 2 + 110);
            }
        }
        
        // æ›´æ–°é©¬é‡Œå¥¥ä½ç½®
        function updateMario() {
            // åº”ç”¨é‡åŠ›
            mario.velocityY += gameState.gravity;
            
            // æ°´å¹³ç§»åŠ¨
            mario.x += mario.velocityX;
            
            // ç¡®ä¿é©¬é‡Œå¥¥ä¸ä¼šç¦»å¼€å±å¹•å·¦ä¾§
            if (mario.x < 0) {
                mario.x = 0;
            }
            
            // ç¡®ä¿é©¬é‡Œå¥¥ä¸ä¼šç¦»å¼€å±å¹•å³ä¾§
            if (mario.x + mario.width > canvas.width) {
                mario.x = canvas.width - mario.width;
            }
            
            // å‚ç›´ç§»åŠ¨
            mario.y += mario.velocityY;
            
            // é‡ç½®åœ°é¢çŠ¶æ€
            mario.onGround = false;
            
            // æ£€æŸ¥ä¸é™æ€å¹³å°çš„ç¢°æ’
            platforms.forEach(platform => {
                // å‚ç›´ç¢°æ’
                if (mario.x < platform.x + platform.width &&
                    mario.x + mario.width > platform.x &&
                    mario.y + mario.height > platform.y &&
                    mario.y + mario.height < platform.y + platform.height &&
                    mario.velocityY > 0) {
                    
                    mario.y = platform.y - mario.height;
                    mario.velocityY = 0;
                    mario.onGround = true;
                }
                
                // æ°´å¹³ç¢°æ’ï¼ˆé˜²æ­¢å¡åœ¨å¹³å°ä¾§é¢ï¼‰
                if (mario.y < platform.y + platform.height &&
                    mario.y + mario.height > platform.y &&
                    mario.x + mario.width > platform.x &&
                    mario.x < platform.x + platform.width) {
                    
                    if (mario.velocityX > 0) {
                        mario.x = platform.x - mario.width;
                    } else if (mario.velocityX < 0) {
                        mario.x = platform.x + platform.width;
                    }
                }
            });
            
            // æ£€æŸ¥ä¸ç§»åŠ¨å¹³å°çš„ç¢°æ’
            movingPlatforms.forEach(platform => {
                // å‚ç›´ç¢°æ’
                if (mario.x < platform.x + platform.width &&
                    mario.x + mario.width > platform.x &&
                    mario.y + mario.height > platform.y &&
                    mario.y + mario.height < platform.y + platform.height &&
                    mario.velocityY > 0) {
                    
                    mario.y = platform.y - mario.height;
                    mario.velocityY = 0;
                    mario.onGround = true;
                    
                    // é©¬é‡Œå¥¥éšç€ç§»åŠ¨å¹³å°æ°´å¹³ç§»åŠ¨
                    mario.x += platform.direction * platform.speed;
                }
            });
            
            // æ£€æŸ¥æ˜¯å¦æ‰å‡ºå±å¹•æˆ–æ‰å…¥ç†”å²©
            if (mario.y > canvas.height) {
                loseLife();
            }
            
            // æ£€æŸ¥ä¸ç†”å²©çš„ç¢°æ’ï¼ˆç¬¬4å…³ï¼‰
            if (gameState.level === 4) {
                lava.forEach(lavaSection => {
                    if (mario.x < lavaSection.x + lavaSection.width &&
                        mario.x + mario.width > lavaSection.x &&
                        mario.y < lavaSection.y + lavaSection.height &&
                        mario.y + mario.height > lavaSection.y) {
                        
                        loseLife();
                    }
                });
            }
            
            // æ£€æŸ¥ä¸æµæ²™çš„ç¢°æ’ï¼ˆç¬¬6å…³ï¼‰ - å‡æ…¢ç§»åŠ¨é€Ÿåº¦
            if (gameState.level === 6) {
                let inQuicksand = false;
                quicksand.forEach(sand => {
                    if (mario.x < sand.x + sand.width &&
                        mario.x + mario.width > sand.x &&
                        mario.y < sand.y + sand.height &&
                        mario.y + mario.height > sand.y) {
                        
                        inQuicksand = true;
                        mario.speed = 2; // å‡æ…¢ç§»åŠ¨é€Ÿåº¦
                    }
                });
                
                if (!inQuicksand) {
                    mario.speed = 5; // æ¢å¤æ­£å¸¸é€Ÿåº¦
                }
            }
            
            // æ£€æŸ¥ä¸é‡‘å¸çš„ç¢°æ’
            coins.forEach(coin => {
                if (!coin.collected) {
                    const dx = mario.x + mario.width/2 - coin.x;
                    const dy = mario.y + mario.height/2 - coin.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < mario.width/2 + coin.radius) {
                        coin.collected = true;
                        gameState.coins++;
                        gameState.score += 100;
                        updateStats();
                        playCoinSound();
                    }
                }
            });
            
            // æ£€æŸ¥ä¸æ•Œäººçš„ç¢°æ’
            enemies.forEach(enemy => {
                if (mario.x < enemy.x + enemy.width &&
                    mario.x + mario.width > enemy.x &&
                    mario.y < enemy.y + enemy.height &&
                    mario.y + mario.height > enemy.y) {
                    
                    // å¦‚æœé©¬é‡Œå¥¥ä»ä¸Šæ–¹è¸©åˆ°æ•Œäºº
                    if (mario.velocityY > 0 && mario.y + mario.height - enemy.y < 10) {
                        // å‡»è´¥æ•Œäºº
                        const index = enemies.indexOf(enemy);
                        if (index > -1) {
                            enemies.splice(index, 1);
                            gameState.score += 200;
                            updateStats();
                            playEnemyDefeatSound();
                        }
                    } else {
                        // é©¬é‡Œå¥¥è¢«æ•Œäººå‡»ä¸­
                        loseLife();
                    }
                }
            });
            
            // æ£€æŸ¥ä¸å°–åˆºçš„ç¢°æ’
            spikes.forEach(spike => {
                // ç®€åŒ–çš„ç¢°æ’æ£€æµ‹
                if (mario.x < spike.x + spike.width &&
                    mario.x + mario.width > spike.x &&
                    mario.y < spike.y + spike.height &&
                    mario.y + mario.height > spike.y) {
                    
                    loseLife();
                }
            });
            
            // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æ——æ†
            if (mario.x + mario.width > flagpole.x &&
                mario.x < flagpole.x + flagpole.width &&
                mario.y + mario.height > flagpole.y &&
                mario.y < flagpole.y + flagpole.height) {
                
                completeLevel();
            }
        }
        
        // æ›´æ–°æ•Œäººä½ç½®
        function updateEnemies() {
            enemies.forEach(enemy => {
                // ç§»åŠ¨æ•Œäºº
                enemy.x += enemy.direction * enemy.speed;
                
                // æ£€æŸ¥æ•Œäººæ˜¯å¦èµ°åˆ°å¹³å°è¾¹ç¼˜
                let onPlatform = false;
                platforms.forEach(platform => {
                    if (enemy.x >= platform.x && 
                        enemy.x + enemy.width <= platform.x + platform.width &&
                        enemy.y + enemy.height >= platform.y - 5 &&
                        enemy.y + enemy.height <= platform.y + 5) {
                        onPlatform = true;
                    }
                });
                
                movingPlatforms.forEach(platform => {
                    if (enemy.x >= platform.x && 
                        enemy.x + enemy.width <= platform.x + platform.width &&
                        enemy.y + enemy.height >= platform.y - 5 &&
                        enemy.y + enemy.height <= platform.y + 5) {
                        onPlatform = true;
                    }
                });
                
                // å¦‚æœæ•Œäººä¸åœ¨å¹³å°ä¸Šæˆ–ç¢°åˆ°è¾¹ç¼˜ï¼Œæ”¹å˜æ–¹å‘
                if (!onPlatform || enemy.x <= 0 || enemy.x + enemy.width >= canvas.width) {
                    enemy.direction *= -1;
                }
            });
        }
        
        // æ›´æ–°ç§»åŠ¨å¹³å°ä½ç½®
        function updateMovingPlatforms() {
            movingPlatforms.forEach(platform => {
                // ç§»åŠ¨å¹³å°
                platform.x += platform.direction * platform.speed;
                
                // æ£€æŸ¥å¹³å°æ˜¯å¦åˆ°è¾¾è¾¹ç•Œ
                if (platform.x <= platform.minX || platform.x >= platform.maxX) {
                    platform.direction *= -1;
                }
            });
        }
        
        // æŸå¤±ç”Ÿå‘½
        function loseLife() {
            gameState.lives--;
            updateStats();
            
            if (gameState.lives <= 0) {
                gameOver();
            } else {
                // é‡ç½®é©¬é‡Œå¥¥ä½ç½®
                mario.x = 50;
                mario.y = gameState.level >= 5 ? 350 : 300;
                mario.velocityX = 0;
                mario.velocityY = 0;
                
                document.getElementById('gameStatus').textContent = `æŸå¤±ä¸€æ¡ç”Ÿå‘½ï¼å‰©ä½™ ${gameState.lives} æ¡ç”Ÿå‘½ã€‚`;
                playHurtSound();
            }
        }
        
        // å®Œæˆå…³å¡
        function completeLevel() {
            gameState.levelComplete = true;
            gameState.score += 500 * gameState.level;
            updateStats();
            
            document.getElementById('gameStatus').textContent = `æ­å–œï¼å®Œæˆç¬¬ ${gameState.level} å…³ï¼`;
            
            // 2ç§’åè¿›å…¥ä¸‹ä¸€å…³
            setTimeout(() => {
                nextLevel();
            }, 2000);
        }
        
        // æ¸¸æˆèƒœåˆ©
        function gameWin() {
            gameState.running = false;
            gameState.gameWin = true;
            gameState.score += 10000; // é€šå…³å¥–åŠ±
            updateStats();
            
            document.getElementById('gameStatus').textContent = `æ­å–œé€šå…³ï¼æœ€ç»ˆå¾—åˆ†: ${gameState.score}ï¼Œè¾“å…¥åå­—ä¿å­˜æˆç»©ï¼`;
            playGameWinSound();
        }
        
        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameState.running = false;
            gameState.gameOver = true;
            document.getElementById('gameStatus').textContent = `æ¸¸æˆç»“æŸï¼æœ€ç»ˆå¾—åˆ†: ${gameState.score}ï¼Œè¾“å…¥åå­—ä¿å­˜æˆç»©ï¼`;
            playGameOverSound();
        }
        
        // ä¿å­˜å½“å‰æˆç»©
        function saveCurrentScore() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert("è¯·è¾“å…¥ä½ çš„åå­—ï¼");
                return;
            }
            
            if (playerName.length > 20) {
                alert("åå­—ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦ï¼");
                return;
            }
            
            // è·å–å½“å‰æ¸¸æˆçŠ¶æ€
            const score = gameState.score;
            const level = gameState.gameWin ? 8 : (gameState.gameOver ? gameState.level - 1 : gameState.level);
            
            addScore(playerName, score, level);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('playerName').value = "";
        }
        
        // å¿«é€Ÿä¿å­˜æˆç»©ï¼ˆæ¸¸æˆç»“æŸæ—¶æŒ‰Fé”®ï¼‰
        function quickSaveScore() {
            if (!gameState.gameOver && !gameState.gameWin) return;
            
            const defaultName = `ç©å®¶${Math.floor(Math.random() * 1000)}`;
            const score = gameState.score;
            const level = gameState.gameWin ? 8 : (gameState.level - 1);
            
            addScore(defaultName, score, level);
        }
        
        // æ¨¡æ‹ŸéŸ³æ•ˆå‡½æ•°
        function playCoinSound() {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ’­æ”¾éŸ³æ•ˆæ–‡ä»¶
            console.log("é‡‘å¸æ”¶é›†éŸ³æ•ˆ");
        }
        
        function playEnemyDefeatSound() {
            console.log("å‡»è´¥æ•ŒäººéŸ³æ•ˆ");
        }
        
        function playHurtSound() {
            console.log("å—ä¼¤éŸ³æ•ˆ");
        }
        
        function playLevelCompleteSound() {
            console.log("è¿‡å…³éŸ³æ•ˆ");
        }
        
        function playGameOverSound() {
            console.log("æ¸¸æˆç»“æŸéŸ³æ•ˆ");
        }
        
        function playGameWinSound() {
            console.log("æ¸¸æˆèƒœåˆ©éŸ³æ•ˆ");
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!gameState.running || gameState.paused || gameState.gameOver || gameState.levelComplete || gameState.gameWin) {
                drawGame();
                requestAnimationFrame(gameLoop);
                return;
            }
            
            // å¤„ç†æŒ‰é”®è¾“å…¥
            if (keys['ArrowLeft'] || keys['KeyA']) {
                mario.velocityX = -mario.speed;
            } else if (keys['ArrowRight'] || keys['KeyD']) {
                mario.velocityX = mario.speed;
            } else {
                mario.velocityX = 0;
            }
            
            if ((keys[' '] || keys['Spacebar'] || keys['ArrowUp'] || keys['KeyW']) && mario.onGround) {
                mario.velocityY = mario.jumpPower;
                mario.onGround = false;
            }
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            updateMario();
            updateEnemies();
            updateMovingPlatforms();
            
            // ç»˜åˆ¶æ¸¸æˆ
            drawGame();
            
            // ç»§ç»­æ¸¸æˆå¾ªç¯
            requestAnimationFrame(gameLoop);
        }
        
        // é”®ç›˜äº‹ä»¶ç›‘å¬
        window.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            
            // æš‚åœ/ç»§ç»­æ¸¸æˆ
            if (e.code === 'KeyP') {
                if (gameState.running && !gameState.gameOver && !gameState.gameWin) {
                    gameState.paused = !gameState.paused;
                    document.getElementById('gameStatus').textContent = gameState.paused ? "æ¸¸æˆæš‚åœ" : "æ¸¸æˆç»§ç»­";
                    document.getElementById('pauseBtn').textContent = gameState.paused ? "ç»§ç»­æ¸¸æˆ" : "æš‚åœæ¸¸æˆ";
                }
            }
            
            // é‡æ–°å¼€å§‹æ¸¸æˆ
            if (e.code === 'KeyR') {
                initGame();
            }
            
            // å¿«é€Ÿä¿å­˜æˆç»©
            if (e.code === 'KeyF') {
                quickSaveScore();
            }
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });
        
        // æŒ‰é’®äº‹ä»¶ç›‘å¬
        document.getElementById('startBtn').addEventListener('click', () => {
            if (!gameState.running || gameState.gameOver || gameState.gameWin) {
                initGame();
                gameState.paused = false;
                document.getElementById('pauseBtn').textContent = "æš‚åœæ¸¸æˆ";
                document.getElementById('gameStatus').textContent = "æ¸¸æˆå¼€å§‹ï¼èº²é¿æ•Œäººï¼Œæ”¶é›†é‡‘å¸ï¼Œåˆ°è¾¾æ——æ†ï¼";
            }
        });
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            initGame();
            gameState.paused = false;
            document.getElementById('pauseBtn').textContent = "æš‚åœæ¸¸æˆ";
        });
        
        document.getElementById('pauseBtn').addEventListener('click', () => {
            if (gameState.running && !gameState.gameOver && !gameState.gameWin) {
                gameState.paused = !gameState.paused;
                document.getElementById('pauseBtn').textContent = gameState.paused ? "ç»§ç»­æ¸¸æˆ" : "æš‚åœæ¸¸æˆ";
                document.getElementById('gameStatus').textContent = gameState.paused ? "æ¸¸æˆæš‚åœ" : "æ¸¸æˆç»§ç»­";
            }
        });
        
        document.getElementById('saveScoreBtn').addEventListener('click', () => {
            if (gameState.gameOver || gameState.gameWin) {
                saveCurrentScore();
            } else {
                alert("æ¸¸æˆç»“æŸåæ‰èƒ½ä¿å­˜æˆç»©ï¼");
            }
        });
        
        document.getElementById('submitScoreBtn').addEventListener('click', saveCurrentScore);
        
        document.getElementById('clearScoresBtn').addEventListener('click', clearScores);
        
        // åˆå§‹åŒ–åˆ†æ•°ç³»ç»Ÿå’Œæ¸¸æˆ
        initScores();
        
        // å¼€å§‹æ¸¸æˆå¾ªç¯
        gameLoop();
    </script>
</body>
</html>
